#Commands
INSTALL ?= /usr/bin/install
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL) -m 644
INSTALL_DIRS = ./tools/mkinstalldirs
RM = /usr/bin/rm -rf
LN = /usr/bin/ln -sf

#Directories with DESTDIR support
libexecdir := $(DESTDIR)${libexecdir}
unitdir := $(DESTDIR)$(PREFIX)/lib/systemd/system
portsdir = $(unitdir)/$(basename).service.d
scheduledir = $(unitdir)/$(basename).timer.d
sbindir := $(DESTDIR)$(sbindir)
docdir := $(DESTDIR)${docdir}/${pkgname}

#Files
basename := upnpc-daemon
scriptname := upnpc-redirect
exec = $(scriptname)
serviceunit = $(basename).service
timerunit = $(basename).timer
units = $(serviceunit) $(timerunit)
ports.conf = ports.conf
schedule.conf = schedule.conf
drop-ins = $(ports.conf) $(schedule.conf)
allfiles = $(exec) $(drop-ins) $(units)
service := /usr/sbin/service
pkg=$(pkgname)-$(pkgversion)
rcname ?= $(sbindir)/rc$(basename)

.PHONY: all installdirs install uninstall install-doc uninstall-doc clean distclean dist

all: $(allfiles)

$(serviceunit): $(srcdir)/$(serviceunit).in
	cp $^ $@
	echo ExecStart=-$(libexecdir)/$(scriptname) >> $@

$(rcname):
	$(LN) $(service) $@

installdirs: $(INSTALL_DIRS)
	$^ $(sbindir) $(libexecdir) $(portsdir) $(scheduledir)

install-doc: README.md
	$(INSTALL_DIRS) $(docdir)
	$(INSTALL_DATA) $^ $(docdir)

install: all installdirs $(rcname) $(installdoc)
	$(INSTALL_PROGRAM) $(exec) $(libexecdir)
	$(INSTALL_DATA) $(units) $(unitdir)
	$(INSTALL_DATA) $(ports.conf) $(portsdir)
	$(INSTALL_DATA) $(schedule.conf) $(scheduledir)

uninstall-doc:
	$(RM) $(docdir)
	
uninstall: uninstall-doc
	$(RM) $(addprefix $(unitdir)/,$(units)) \
              $(libexecdir)/$(scriptname) \
              $(portsdir) $(scheduledir) $(rcname)

clean:
	$(RM) $(serviceunit) $(pkg).tar.gz

dist: distclean
	@echo "Creating $(pkg).tar.gz..."
	$(INSTALL_DIRS) $(pkg) && cd $(pkg) && $(LN) ../* . && $(RM) $(pkg)
	tar -chzf $(pkg).tar.gz $(pkg) && $(RM) $(pkg)

Makefile: ${srcdir}/Makefile.in VERSION config.status
	$(RM) Makefile
	./config.status

# Not impliemented yet
rpm: $(pkgname).spec
		rpmbuild -ba --clean $<

distclean: clean
	$(RM) Makefile config.status

