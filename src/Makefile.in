#Commands
INSTALL ?= /usr/bin/install
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL) -m 644
INSTALL_DIRS = ./tools/mkinstalldirs
RM = /usr/bin/rm -rf
LN = /usr/bin/ln -sf

#Directories with DESTDIR support
libexecdir := $(DESTDIR)${libexecdir}
unitdir := $(DESTDIR)$(PREFIX)/lib/systemd/system
portsdir = $(unitdir)/$(basename).service.d
scheduledir = $(unitdir)/$(basename).timer.d
sbindir := $(DESTDIR)$(sbindir)
docdir := $(DESTDIR)${docdir}/${pkgname}

#Files
basename := upnpc-daemon
scriptname := upnpc-redirect
exec = $(srcdir)/$(scriptname)
serviceunit = $(srcdir)/$(basename).service
timerunit = $(srcdir)/$(basename).timer
units = $(serviceunit) $(timerunit)
ports.conf = $(srcdir)/ports.conf
schedule.conf = $(srcdir)/schedule.conf
drop-ins = $(ports.conf) $(schedule.conf)
allfiles = $(exec) $(drop-ins) $(units)
service := /usr/sbin/service
rcname ?= $(sbindir)/rc$(basename)

.PHONY: all installdirs install uninstall clean distclean dist install-doc $(rcname)

all: $(allfiles)

$(serviceunit): $(serviceunit).in
	cp $^ $@
	echo ExecStart=-$(libexecdir)/$(scriptname) >> $@

installdirs: $(INSTALL_DIRS)
	$^ $(sbindir) $(libexecdir) $(portsdir) $(scheduledir)

$(rcname):
	$(LN) $(service) $@

install-doc: README.md
	$(INSTALL_DIRS) $(docdir)
	$(INSTALL_DATA) $^ $(docdir)

install: all installdirs install-doc $(rcname)
	$(INSTALL_PROGRAM) $(exec) $(libexecdir)
	$(INSTALL_DATA) $(ports.conf) $(portsdir)
	$(INSTALL_DATA) $(schedule.conf) $(scheduledir)
	$(INSTALL_DATA) $(units) $(unitdir)

uninstall: 
	$(RM) $(units:$(srcdir)%=$(unitdir)%) \
              $(libexecdir)/$(scriptname) \
              $(portsdir) $(scheduledir) $(rcname) 
clean:
	$(RM) $(serviceunit)

dist: $(SRCS) $(AUX)
	echo tar-`sed \
             -e '/version_string/!d' \
             -e 's/[^0-9.]*\([0-9.]*\).*/\1/' \
             -e q
	version.c` > .fname
	-rm -rf `cat .fname`
	mkdir `cat .fname`
	ln $(SRCS) $(AUX) `cat .fname`
	tar chZf `cat .fname`.tar.Z `cat .fname`
	-rm -rf `cat .fname` .fname

Makefile: Makefile.in VERSION
	./configure

distclean: clean
	$(RM) Makefile

